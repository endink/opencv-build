name: Build

on:
  workflow_dispatch:
    inputs:
      opencv-version:
        description: "OpenCV Version"
        type: string
        default: 4.11.0
      target:
        description: "Build Target"
        default: all
        type: choice
        options:
          - win-x64-static-md
          - win-x64-static-mt
          - linux-x64-static
          - android-21-ndk-r25b-static
          - android-21-ndk-r25b-shared
          - android-29-ndk-r27d-static
          - android-29-ndk-r27d-shared
          - all
      release:
        description: "Modify Release"
        default: "No"
        type: choice
        options:
          - "Yes"
          - "No"

  push:
    tags:
      - v*.*.*

env:
  GCC_VERSION: 11
  CMAKE_VERSION: 3.26
  PYTHON_VERSION: 3.9
  NODE_VERSION: 20
  XCODE_VERSION: 14.2
  MACOSX_DEPLOYMENT_TARGET: 10.15
  BUILD_TARGET: ${{ inputs.target || 'all' }}
  WIN_SDK_VERSION: 10.0.22621.0
  IS_RELEASE: ${{ inputs.release || 'Yes' }}

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.runs-on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-x64-static
            runs-on: ubuntu-22.04
            build: ./build-static_lib.sh
            post-build: tar -czvf $ARCHIVE_DIR/$ARCHIVE_NAME.tgz -C $OUTPUT_DIR .

          - target: win-x64-static-md
            runs-on: windows-2022
            shell: cmd
            build: |
              set "CMAKE_OPTIONS=-A x64 -DUSE_MSVC_STATIC_RUNTIME=OFF -T v143,version=14.38.33130 "
              set "CMAKE_GENERATOR=Ninja"
              call C:\VS_BUILD\Common7\Tools\VsDevCmd.bat -arch=x64 -host_arch=x64
              .\build-windows.bat
            post-build: 7z a %ARCHIVE_DIR%\%ARCHIVE_NAME%.zip %OUTPUT_DIR%\*

          - target: win-x64-static-mt
            runs-on: windows-2022
            shell: cmd
            build: |
              set "CMAKE_OPTIONS=-A x64 -DUSE_MSVC_STATIC_RUNTIME=ON -T v143,version=14.38.33130 "
              call C:\VS_BUILD\Common7\Tools\VsDevCmd.bat -arch=x64 -host_arch=x64
              .\build-windows.bat
            post-build: 7z a %ARCHIVE_DIR%\%ARCHIVE_NAME%.zip %OUTPUT_DIR%\*

          - target: android-21-ndk-r25b-shared
            runs-on: ubuntu-22.04
            prepare: ./setup_ndk.sh r25b
            build: ./build-android.sh r25b shared 21
            post-build: tar -czvf $ARCHIVE_DIR/$ARCHIVE_NAME.tgz -C $OUTPUT_DIR .

          - target: android-21-ndk-r25b-static
            runs-on: ubuntu-22.04
            prepare: ./setup_ndk.sh r25b
            build: ./build-android.sh r25b static 21
            post-build: tar -czvf $ARCHIVE_DIR/$ARCHIVE_NAME.tgz -C $OUTPUT_DIR .

          - target: android-29-ndk-r27d-shared
            runs-on: ubuntu-22.04
            prepare: ./setup_ndk.sh r27d
            build: ./build-android.sh r27d shared 29
            post-build: tar -czvf $ARCHIVE_DIR/$ARCHIVE_NAME.tgz -C $OUTPUT_DIR .

          - target: android-29-ndk-r27d-static
            runs-on: ubuntu-22.04
            prepare: ./setup_ndk.sh r27d
            build: ./build-android.sh r27d static 29
            post-build: tar -czvf $ARCHIVE_DIR/$ARCHIVE_NAME.tgz -C $OUTPUT_DIR .

    steps:
      - name: Evaluate build enable
        id: eval
        run: echo "enabled=${{ env.BUILD_TARGET == 'all' || env.BUILD_TARGET == matrix.target }}" >> $GITHUB_OUTPUT

      - name: Set OpenCV version
        if: steps.eval.outputs.enabled == 'true'
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "OPENCV_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
          else
            echo "OPENCV_VERSION=${{ inputs.opencv-version }}" >> $GITHUB_ENV
          fi

      - name: Set environment variables
        if: steps.eval.outputs.enabled == 'true'
        run: |
          echo OUTPUT_DIR=${GITHUB_WORKSPACE}/output >> $GITHUB_ENV
          echo ARCHIVE_DIR="${{ runner.temp }}" >> $GITHUB_ENV
          echo ARCHIVE_NAME=opencv-${{ matrix.target }}-${{ env.OPENCV_VERSION }} >> $GITHUB_ENV

      - name: Setup Android environment
        if: startsWith(matrix.target, 'android') && steps.eval.outputs.enabled == 'true'
        run: |
          echo "ANDROID_HOME=${GITHUB_WORKSPACE}/AndroidHome" >> $GITHUB_ENV
          mkdir -p "${GITHUB_WORKSPACE}/AndroidHome"

      - name: Checkout
        if: steps.eval.outputs.enabled == 'true'
        uses: actions/checkout@v4

      - name: Install VS Build Tools
        if: runner.os == 'Windows' && steps.eval.outputs.enabled == 'true'
        shell: cmd
        run: |
          echo Checking if VS Build Tools already installed...
        
          if exist "C:\VS_BUILD\Common7\Tools\VsDevCmd.bat" (
            echo VS Build Tools already installed.
            goto :eof
          )
        
          echo Downloading VS Build Tools installer...
          curl -L -o vs_buildtools.exe https://aka.ms/vs/17/release/vs_BuildTools.exe
        
          if errorlevel 1 (
            echo Download failed.
            exit /b 1
          )
        
          if not exist vs_buildtools.exe (
            echo Installer not found after download.
            exit /b 1
          )
        
          echo Installing VS Build Tools...
          start /wait vs_buildtools.exe ^
            --quiet --wait --norestart --nocache ^
            --installPath C:\VS_BUILD ^
            --channelUri https://aka.ms/vs/17/release/channel ^
            --installChannelUri https://aka.ms/vs/17/release/channel ^
            --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 ^
            --includeRecommended
        
          if errorlevel 1 (
            echo VS Build Tools installation failed.
            exit /b 1
          )
        
          if not exist "C:\VS_BUILD\Common7\Tools\VsDevCmd.bat" (
            echo Installation finished but VsDevCmd.bat not found.
            exit /b 1
          )
        
          echo VS Build Tools installed successfully.

      - name: Checkout OpenCV
        if: steps.eval.outputs.enabled == 'true'
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv
          submodules: true
          ref: ${{ env.OPENCV_VERSION }}
          path: opencv

      - name: Setup GCC
        if: runner.os == 'Linux' && !startsWith(matrix.target, 'android') && steps.eval.outputs.enabled == 'true'
        uses: egor-tensin/setup-gcc@v1
        with:
          version: ${{ env.GCC_VERSION }}

      - name: Setup CMake
        if: steps.eval.outputs.enabled == 'true'
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: ${{ env.CMAKE_VERSION }}

      - name: Setup Android NDK
        if: startsWith(matrix.target, 'android') && steps.eval.outputs.enabled == 'true'
        run: ${{ matrix.prepare }}

      - name: Build
        if: steps.eval.outputs.enabled == 'true'
        shell: ${{ matrix.shell || 'bash' }}
        run: ${{ matrix.build }}

      - name: Post build
        if: steps.eval.outputs.enabled == 'true'
        shell: ${{ matrix.shell || 'bash' }}
        run: ${{ matrix.post-build }}

      - name: Upload artifact
        if: steps.eval.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          compression-level: 9
          retention-days: 1
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_DIR }}/${{ env.ARCHIVE_NAME }}.*

  release:
    name: Release
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Set OpenCV version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "OPENCV_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
          else
            echo "OPENCV_VERSION=${{ inputs.opencv-version }}" >> $GITHUB_ENV
          fi

      - uses: actions/download-artifact@v4
        with:
          path: /tmp/artifact

      - name: Release
        if: ${{ env.IS_RELEASE == 'Yes' }}
        uses: ncipollo/release-action@v1
        with:
          omitName: true
          body: "Official Release: OpenCV v${{ env.OPENCV_VERSION }}"
          artifacts: "/tmp/artifact/*/*.tgz,/tmp/artifact/*/*.zip"
          tag: "v${{ env.OPENCV_VERSION }}"
          allowUpdates: true